<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>日期计算器</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet/less" type="text/css" href="less/styles.less" />
    <link rel="stylesheet" href="vendor/swiper-bundle.css" />
    <script src="vendor/less.js"></script>
  </head>
  <body>
    <main>
      <label for="in-date-start">
        开始日期
        <input type="date" name="start" id="in-date-start" />
      </label>
      <p>相差<span data-diff-in-days>0</span>天</p>
      <label for="in-date-end">
        结束日期
        <input type="date" name="end" id="in-date-end" />
      </label>
    </main>
    <section class="calendar">
      <ol class="calendar--weekday-bar">
        <li class="calendar--weekday-bar__weekend">日</li>
        <li>一</li>
        <li>二</li>
        <li>三</li>
        <li>四</li>
        <li>五</li>
        <li class="calendar--weekday-bar__weekend">六</li>
      </ol>
      <div class="calendar--month-list"></div>
    </section>
  </body>
  <script src="vendor/jquery.js"></script>
  <script type="module">
    import { daysBetween } from "./js/date-util.js";

    const $dateStart = $("#in-date-start");
    const $dateEnd = $("#in-date-end");
    const $diffInDays = $("[data-diff-in-days]");

    function updateDateDiff() {
      const startIsSet = $dateStart.val() !== "";
      const endIsSet = $dateEnd.val() !== "";
      const bothDatesAreSet = startIsSet && endIsSet;
      if (!bothDatesAreSet) {
        return;
      }

      $diffInDays.text(daysBetween($dateStart.val(), $dateEnd.val()));
    }

    $dateStart.on("change", updateDateDiff);
    $dateEnd.on("change", updateDateDiff);
  </script>
  <script type="module">
    import {
      daysInMonth,
      getYearMonthString,
      weekDayOfFirstDayInMonthWeekStartFromSunday,
    } from "./js/date-util.js";

    function createMonthGrid(year, month) {
      const $m = $(
        `<div class='month' data-year='${year}' data-month='${month}'>`,
      );
      $m.append($("<h3>").text(getYearMonthString(year, month)));
      const $dg = $("<ul class='day-grid'>");
      for (let i = 0; i < 5 * 7; i++) {
        $dg.append($("<li class='day-grid--day'>"));
      }
      $m.append($dg);

      const firstDayWeekDay = weekDayOfFirstDayInMonthWeekStartFromSunday(
        year,
        month,
      );
      const dayCnt = daysInMonth(year, month);
      for (
        let cell = firstDayWeekDay, day = 1;
        cell <= 35 && day <= dayCnt;
        cell++
      ) {
        const $d = $dg.children().eq(cell - 1);
        $d.text(day);
        day++;
      }

      return $m;
    }

    function addTodayStyleToMonthGrid($m) {
      const year = parseInt($m.attr("data-year"));
      const month = parseInt($m.attr("data-month"));
      const t = new Date();
      const monthToBeRendered = new Date(year, month - 1);
      const todayIsInThisMonth =
        t.getFullYear() === monthToBeRendered.getFullYear() &&
        t.getMonth() === monthToBeRendered.getMonth();
      if (todayIsInThisMonth) {
        const today = t.getDate();
        $m.find(`.day-grid--day:contains(${today})`).addClass(
          "day-grid--day__today",
        );
      }
      return $m;
    }

    function addWeekendStyleToMonthGrid($m) {
      const year = parseInt($m.attr("data-year"));
      const month = parseInt($m.attr("data-month"));
      const thisMonth = new Date(year, month - 1, 1);
      $m.find(".day-grid--day").each(function () {
        const $d = $(this);
        const day = $d.text();
        if (day === "") {
          return;
        }
        thisMonth.setDate(day);
        const weekDay = thisMonth.getDay();
        if (weekDay === 0 || weekDay === 6) {
          $d.addClass("day-grid--day__weekend");
        }
      });
      return $m;
    }

    const $calendarMonthList = $(".calendar--month-list");
    for (let i = 0; i < 12; i++) {
      $calendarMonthList.append(
        addWeekendStyleToMonthGrid(
          addTodayStyleToMonthGrid(createMonthGrid(2024, i + 1)),
        ),
      );
    }
  </script>
</html>
