<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>日期计算器</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet/less" type="text/css" href="less/styles.less" />
    <script src="vendor/less.js"></script>
  </head>
  <body>
    <label for="in-date-start" class="input-date">
      开始日期
      <input type="date" name="start" id="in-date-start" />
    </label>
    <p>相差<span data-diff-in-days>0</span>天</p>
    <label for="in-date-end" class="input-date">
      结束日期
      <input type="date" name="end" id="in-date-end" />
    </label>
    <section class="calendar">
      <ol class="calendar--weekday-bar">
        <li class="calendar--weekday-bar__weekend">日</li>
        <li>一</li>
        <li>二</li>
        <li>三</li>
        <li>四</li>
        <li>五</li>
        <li class="calendar--weekday-bar__weekend">六</li>
      </ol>
      <div class="calendar--month-list"></div>
    </section>
  </body>
  <script src="vendor/jquery.js"></script>
  <script type="module">
    import { daysBetween } from "./js/date-util.js";

    const $dateStart = $("#in-date-start");
    const $dateEnd = $("#in-date-end");
    const $diffInDays = $("[data-diff-in-days]");

    function updateDateDiff() {
      const startIsSet = $dateStart.val() !== "";
      const endIsSet = $dateEnd.val() !== "";
      const bothDatesAreSet = startIsSet && endIsSet;
      if (!bothDatesAreSet) {
        return;
      }

      $diffInDays.text(daysBetween($dateStart.val(), $dateEnd.val()));
    }

    $dateStart.on("change", updateDateDiff);
    $dateEnd.on("change", updateDateDiff);
    $(".input-date > input[type=date]").on("change", (e) => {
      const $date = $(e.target);
      $date.closest(".input-date").text($date.val());
    });
  </script>
  <script type="module">
    import {
      daysInMonth,
      getYearMonthString,
      isOnSameDate,
      weekDayOfFirstDayInMonthWeekStartFromSunday,
    } from "./js/date-util.js";
    import addInfiniteScrollEffect from "./js/infinite-scroll.js";

    /**
     * @param {number} year
     * @param {number} month
     * @param {(dayElement: jQuery, date: Date) => void} hookAfterCreateOneDay
     *
     * @return jQuery
     */
    function createMonthGrid(year, month, hookAfterCreateOneDay) {
      const $m = $(`<div class='month'>`);
      $m.append($("<h3>").text(getYearMonthString(year, month)));
      const $dg = $("<ul class='day-grid'>");
      const maxWeeksOneMonthCanSpanAcross = 6;
      for (let i = 0; i < maxWeeksOneMonthCanSpanAcross * 7; i++) {
        $dg.append($("<li class='day-grid--day'>"));
      }
      $m.append($dg);

      const firstDayWeekDay = weekDayOfFirstDayInMonthWeekStartFromSunday(
        year,
        month,
      );
      const dayCnt = daysInMonth(year, month);
      const today = new Date();
      const someDayThisMonth = new Date(year, month - 1);
      $m.attr("data-year", someDayThisMonth.getFullYear());
      $m.attr("data-month", someDayThisMonth.getMonth() + 1);
      for (
        let cell = firstDayWeekDay, day = 1;
        cell <= maxWeeksOneMonthCanSpanAcross * 7 && day <= dayCnt;
        cell++
      ) {
        const $d = $dg.children().eq(cell - 1);
        $d.text(day);
        someDayThisMonth.setDate(day);
        const wd = someDayThisMonth.getDay();
        if (wd === 0 || wd === 6) {
          $d.addClass("day-grid--day__weekend");
        }
        if (isOnSameDate(someDayThisMonth, today)) {
          $d.addClass("day-grid--day__today");
        }
        hookAfterCreateOneDay($d, someDayThisMonth);
        day++;
      }

      return $m;
    }

    const $calendarMonthList = $(".calendar--month-list");
    const $calendar = $(".calendar");
    $calendar.css("width", `${$calendar.width()}px`);
    $calendar.css("left", "100vw");
    const today = new Date();

    $(".input-date").on("click", (e) => {
      const $dateInput = $(e.target).children("input[type=date]");
      console.log("input date click");

      let isDefaultSelected;
      if ($dateInput.val() !== "") {
        console.log($dateInput.val(), "will be selected");
        isDefaultSelected = (d) => isOnSameDate(new Date($dateInput.val()), d);
      } else {
        isDefaultSelected = () => false;
      }

      const close = showCalendar(
        new Date(2024, 2 - 1),
        (date, selected) => {
          console.log("calendar on change", date, selected);
        },
        (date) => isOnSameDate(today, date),
        isDefaultSelected,
        (d) => d <= today,
      );
    });

    /**
     * @param {Date} yearAndMonth
     * @param {(day: Date, selected: boolean) => void} onChange
     * @param {(yearMonthDate: Date) => boolean} isToday
     * @param {(yearMonthDate: Date) => boolean} isDefaultSelected
     * @param {(yearMonthDate: Date) => boolean} canSelect
     *
     * @return closeCalendar: () => void
     */
    function showCalendar(
      yearAndMonth,
      onChange = () => {},
      isToday = () => true,
      isDefaultSelected = () => false,
      canSelect = () => true,
    ) {
      function chain(...fnList) {
        return (...args) => fnList.reduce((_, fn) => fn(...args), undefined);
      }

      const addAfterEffects = chain(
        ($d, date) => {
          if (isToday(date)) {
            $d.addClass("day-grid--day__today");
          }
        },
        ($d, date) => {
          if (!canSelect(date)) {
            $d.addClass("day-grid--day__disable");
          }
        },
        ($d, date) => {
          if (isDefaultSelected(date)) {
            $d.attr("data-calendar-selected", true);
            $d.addClass("day-grid--day__selected");
          }
        },
      );

      const monthListNotInitialized =
        $calendarMonthList.children().length === 0;
      if (monthListNotInitialized) {
        const initYear = yearAndMonth.getFullYear();
        const initMonth = yearAndMonth.getMonth() + 1;
        addInfiniteScrollEffect(
          $calendarMonthList,
          (key) => {
            // + 1 is magic to make initMonth the first full visible month grid
            return createMonthGrid(
              initYear,
              initMonth + key + 1,
              addAfterEffects,
            );
          },
          {
            initLen: 12,
            preload: 6,
            maxLen: 24,
          },
        );

        $(".calendar--weekday-bar").css(
          "width",
          $calendarMonthList.children(".month").eq(0).width(),
        );

        $calendarMonthList.on("click", ".day-grid--day", (e) => {
          const $day = $(e.target);
          const $month = $day.closest(".month");
          const date = new Date(
            +$month.attr("data-year"),
            +$month.attr("data-month") - 1,
            +$day.text(),
          );
          console.log("day click", $day.text(), date);

          const previousIsUnselected =
            $day.attr("data-calendar-selected") === undefined;
          if (previousIsUnselected) {
            $day.add("day-grid--day__selected");
            $day.attr("data-calendar-selected", "ok");
          } else {
            $day.remove("day-grid--day__selected");
            $day.attr("data-calendar-selected", undefined);
          }
          onChange(date, !previousIsUnselected);
        });
      }

      $calendar.animate({ left: "0vw" });
      return () => $calendar.animate({ left: "100vw" });
    }
  </script>
</html>
