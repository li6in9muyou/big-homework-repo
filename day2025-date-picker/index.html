<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>日期计算器</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet/less" type="text/css" href="less/styles.less" />
    <script src="vendor/less.js"></script>
  </head>
  <body>
    <section class="calendar">
      <ol class="calendar--weekday-bar">
        <li class="calendar--weekday-bar__weekend">日</li>
        <li>一</li>
        <li>二</li>
        <li>三</li>
        <li>四</li>
        <li>五</li>
        <li class="calendar--weekday-bar__weekend">六</li>
      </ol>
      <div class="calendar--month-list"></div>
    </section>
  </body>
  <script src="vendor/jquery.js"></script>
  <script type="module">
    import { daysBetween } from "./js/date-util.js";

    const $dateStart = $("#in-date-start");
    const $dateEnd = $("#in-date-end");
    const $diffInDays = $("[data-diff-in-days]");

    function updateDateDiff() {
      const startIsSet = $dateStart.val() !== "";
      const endIsSet = $dateEnd.val() !== "";
      const bothDatesAreSet = startIsSet && endIsSet;
      if (!bothDatesAreSet) {
        return;
      }

      $diffInDays.text(daysBetween($dateStart.val(), $dateEnd.val()));
    }

    $dateStart.on("change", updateDateDiff);
    $dateEnd.on("change", updateDateDiff);
  </script>
  <script type="module">
    import {
      daysInMonth,
      getYearMonthString,
      isOnSameDate,
      weekDayOfFirstDayInMonthWeekStartFromSunday,
    } from "./js/date-util.js";

    function createMonthGrid(year, month) {
      const $m = $(
        `<div class='month' data-year='${year}' data-month='${month}'>`,
      );
      $m.append($("<h3>").text(getYearMonthString(year, month)));
      const $dg = $("<ul class='day-grid'>");
      for (let i = 0; i < 5 * 7; i++) {
        $dg.append($("<li class='day-grid--day'>"));
      }
      $m.append($dg);

      const firstDayWeekDay = weekDayOfFirstDayInMonthWeekStartFromSunday(
        year,
        month,
      );
      const dayCnt = daysInMonth(year, month);
      const today = new Date();
      const someDayThisMonth = new Date(year, month - 1);
      for (
        let cell = firstDayWeekDay, day = 1;
        cell <= 35 && day <= dayCnt;
        cell++
      ) {
        const $d = $dg.children().eq(cell - 1);
        $d.text(day);
        someDayThisMonth.setDate(day);
        const wd = someDayThisMonth.getDay();
        if (wd === 0 || wd === 6) {
          $d.addClass("day-grid--day__weekend");
        }
        if (isOnSameDate(someDayThisMonth, today)) {
          $d.addClass("day-grid--day__today");
        }
        day++;
      }

      return $m;
    }

    const $calendarMonthList = $(".calendar--month-list");
    // for (let i = 0; i < 12; i++) {
    //   $calendarMonthList.append(createMonthGrid(2024, i + 1));
    // }

    const infiniteScrollEffect = new (function (viewportH, getItem, list) {
      this.renderedH = 0;
      this.vpH = viewportH;
      this.list = list;
      this.keyFront = 0;
      this.keyBack = 0;

      while (this.renderedH < 1.5 * this.vpH) {
        const item = getItem(this.keyBack);
        $(item).attr("data-inf-scr-key", this.keyBack);
        this.keyBack += 1;
        this.list.append(item);
        this.renderedH += item.outerHeight();
      }

      document.addEventListener(
        "scroll",
        () => {
          console.log(
            "whether to append to list",
            this.renderedH,
            document.documentElement.scrollTop,
          );
          if (
            this.renderedH - document.documentElement.scrollTop <
            1.5 * this.vpH
          ) {
            const item = getItem(this.keyBack);
            $(item).attr("data-inf-scr-key", this.keyBack);
            this.keyBack += 1;
            this.list.append(item);
            this.renderedH += item.outerHeight();
          }

          const minKeyFront = this.keyBack - 7;
          if (minKeyFront >= 0) {
            for (let toDelete = 0; toDelete < minKeyFront; toDelete++) {
              this.list.children(`[data-inf-scr-key=${toDelete}]`).remove();
              this.keyFront += 1;
            }
          }
        },
        { passive: true },
      );
    })(
      document.documentElement.clientHeight -
        $(".calendar--weekday-bar").height(),
      (key) =>
        $(
          `<div style='height:${Math.floor(
            100 + 200 * Math.random(),
          )}px;margin:6px;text-align:center;background-color: mediumvioletred;border:solid 2px white;font-size: 90px'>${key}</div>`,
        ),
      $calendarMonthList,
    );
  </script>
</html>
